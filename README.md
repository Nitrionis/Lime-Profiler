# Профилирование движка Citrus

## Содержание

* [Сборка](#Сборка)
* [Интерфейс](#Интерфейс)
* [Подключение из игры](#Подключение-из-игры)
* [Профайлеры](#Профайлеры) 
* [Cpu Profiler](#cpu-profiler) 
* [Gpu Profiler](#gpu-profiler)
* [LimeProfiler](#limeprofiler)
* [Клиент-серверное взаимодействие](#Клиент-серверное-взаимодействие)
* [Исправление ошибок](#Исправление-ошибок)
* [Профилирование кастомных компонентов](#Профилирование-кастомных-компонентов)
* [Термины](#Термины)

<br/>

## Сборка

Чтобы использовать профайлер, необходимо установить флаг компиляции `LIME_PROFILER` в следующие проекты для всех платформ:

* Lime.*
* Tangerine.Core.*
* Tangerine.UI.SceneView.*
* Tangerine.UI.Profiler.*

<br/>


## Интерфейс

### Состав интерфейса:

* Главное меню
* Меню настроек
* График загрузки CPU
* График загрузки GPU
* Гравик сведений об отрисованной геометрии
* Таймлайн GPU для выбранного [update](#термины)-а
* Таймлайн CPU для выбранного [update](#термины)-а

### Главное меню

* `Settings` - включает и отключает видимость меню настроек.
* `Mode` - переключает режимы профилирования.
* * `This device` - профилирования текущего экземпляра движка.
* * `Remote device` - профилирования скомпилированной игры.
* `IP:Port Label` - активен, когда профайлер в режиме `Remote device`, указывает IP и порт, которые необходимо вписать в игре для подключения к движку.
* `Pause/Continue` - приостанавливает и возобновляет профилирование.
* `Select scene only/Select not only scene` - фильтр результатов профилирования по сцене.
* `Select Node by id` - фильтр результататов по Node.Id.
* `Node.Id Regex` - регулярное выражение Node.Id фильтра.

### Меню настроек

* `CPU Charts` - включает и отключает видимость графиков CPU.
* `GPU Charts` - включает и отключает видимость графиков GPU.
* `Geometry Charts` - включает и отключает видимость графиков геометрии.
* `GPU trace timeline` - включает и отключает видимость GPU таймлайна.
* `CPU trace timeline` - включает и отключает видимость CPU таймлайна.
* `Deep profiling GPU` - включает и отключает провилирование каждого вызова отрисоки.
* `Scene only GPU deep profiling` - ограничивает `Deep profiling GPU` сценой. Когда активно, улучшает производительность.

### График загрузки центрального процессора

Предоставляет данные загруженности центрального процессора за последние 160 [update](#термины)-ов.
Для каждого [update](#термины)-а визуализированны:

* `CPU` - полное время затраченное центральным процессором на [update](#термины). 
* `Selected` - время оновления Node-ов, id которых удовлетворяет `Node.Id Regex` в [главном меню](#Главное-меню).

> Область `CPU` включает в себя время простоя перед следующим [update](#термины)-ом.<br/>
> Область `Selected` является результатом запроса к 'базе данных' из 160 [update](#термины)-ов и не обновляется автоматически.
> Для обновления области необходимо перевыбрать результаты через [главное меню](#Главное-меню).

### График загрузки видеокарты

Предоставляет данные загруженности видеокарты за последние 160 [update](#термины)-ов. Для каждого [update](#термины)-а визуализированны:
* `GPU` - полное время затраченное видеокартой на [frame](#термины).
* `Selected` - время затраченное на выполнение вызовов отрисовки, у которых id хотя бы одного из владельцев удовлетворяет `Node.Id Regex` в [главном меню](#Главное-меню).

> Владельцы - это Node-ы, которым принадлежит вызов отрисовки. Владельцев может быть несколько, если ноды были отрисованы одним батчем.<br/>
> Область `Selected` является результатом запроса к 'базе данных' из 160 [update](#термины)-ов и не обновляется автоматически.
> Для обновления области необходимо перевыбрать результаты через [главное меню](#Главное-меню).

#### Алгоритм расчета Selected области


### Гравик сведений об отрисованной геометрии

Предоставляет данные по отправленной на рендеринг геометрии за последние 160 [update](#термины)-ов. 

### Таймлайн GPU для выбранного [frame](#термины)-а

Наглядно представляет время выполнения вызовов отрисовки для одного [frame](#термины)-а.<br/>

Для выбора [frame](#термины)-а неодходимо кликнуть по одному из графиков (`CPU Charts`, `GPU Charts`, `Geometry Charts`).
После этого в таймлайне визуализируется кадр, связанный с выбранными данными на графике.<br/>

Для каждого вызова отрисовки (цветного прямоугольника) доступны:
* `Owners list` - список id-ов Node, которые были отрисованы этим вызовом.
* `Material` - название материала.
* `Pass` - индекс прохода в `Material`-е.
* `Render time` - время рендеринга.
* `Vertices` - количество вершин.
* `Triangles` - количество треугольников.

> Если вызов отрисовки принадлежит одной ноде, тогда `Owners list` имеет формат<br/> |Owners|Node.Id|
> * |Owners| - префикс.
> * |Node.Id| - Node.Id.
>
> Если вызов отрисовки принадлежит батчу, тогда `Owners list` имеет формат<br/> |Owners batch|Batch-size|Node.Id|Count-of-Node.Id|.
> * |Owners batch| - префикс.
> * |Batch size| - количество Node в батче.
> * |Node.Id| - Node.Id.
> * |Count-of-Node.Id| - количество Node в батче с данным |Node.Id|.

Прокрутка таймлайна:
* `Mouse-wheel` - горизонтальная прокрутка.
* `Shift + Mouse-wheel` - вертикальная прокрутка.
* `Ctrl + Mouse-wheel` - изменение масштаба.

<br/>

### Таймлайн СPU для выбранного [update](#термины)-а

Наглядно представляет данные об использовании CPU для одного [update](#термины)-а.<br/>

Для выбора [update](#термины)-а неодходимо кликнуть по одному из графиков (`CPU Charts`, `GPU Charts`, `Geometry Charts`).
После этого в таймлайне визуализируется кадр, связанный с выбранными данными на графике.<br/>

`CpuUsage` - характеризует интервал времени использования CPU.

Для каждого `CpuUsage` (цветного прямоугольника) доступны:
* `Reason` - причина использования CPU:
* * `Animation` - обработка анимации.
* * `Update` - обработка событий Update-a.
* * `Gesture` - обработка нажатий мыши.
* * `RenderPreparation` - получение RenderObject-ов.
* * `NodeRender` - запись команд рисования или создание батча.
* * `BatchRender` - запись команд рисования для батча.
* `Time` - время выполнения.
* `Owner` - Node.Id.

Прокрутка таймлайна:
* `Mouse-wheel` - горизонтальная прокрутка.
* `Shift + Mouse-wheel` - вертикальная прокрутка.
* `Ctrl + Mouse-wheel` - изменение масштаба.

<br/>

## Подключение из игры

Подключение из скомпилированной игры осуществляется через компонент `ProfilerGameUI`. 
Создать его можно через меню `Create` -> `Create ProfilerGameUI`. Компонент содержит:
* `Status Label` - отображает текущее состояние.
* `IP:Port Input` - используется для ввода ip адреса и порта движка.
* `Connect/Disconnect Button` - для подключения к движку и отключения от движка.

<br/>

## Профайлеры

<br/>

## Cpu Profiler

<br/>

## Gpu Profiler

<br/>

## LimeProfiler

<br/>

## Клиент-серверное взаимодействие

<br/>

## Исправление ошибок

<br/>

## Профилирование кастомных компонентов

<br/>

## Термины

Update - это одна итерация цикла одновления состояний объектов движка.<br/>
Rendering - запись и отправка комманд рисования в GPU, порождённые Update-ом.<br/>
Frame - это кадр отрисованный видеокартой, представляет результат выполнения Rendering-а.<br/>
